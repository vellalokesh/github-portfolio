<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marks Entry - Smart Register</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #2ecc71, #3498db); display: flex; flex-direction: column; align-items: center; padding: 20px; transition: opacity 0.3s ease; }
        .header { width: 100%; padding: 20px 40px; background: #ffffff; border-radius: 0 0 15px 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; transition: all 0.3s ease; }
        .header:hover { box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); }
        .header-greeting { font-size: 26px; font-weight: 600; color: #2c3e50; text-align: center; flex-grow: 1; }
        .hamburger { display: none; font-size: 24px; background: none; border: none; color: #2c3e50; cursor: pointer; padding: 5px; }
        .menu-container { position: relative; }
        .menu { display: flex; gap: 10px; }
        .back-btn { padding: 12px 20px; background: #3498db; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background 0.3s ease, transform 0.2s ease; position: relative; overflow: hidden; }
        .back-btn:hover { background: #2980b9; transform: translateY(-2px); }
        .menu-btn { padding: 12px 20px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background 0.3s ease, transform 0.2s ease; }
        .menu-btn:hover { background: #c0392b; transform: translateY(-2px); }
        .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #34495e; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 12px; visibility: hidden; opacity: 0; transition: opacity 0.2s ease; margin-bottom: 5px; }
        .back-btn:hover .tooltip, .menu-btn:hover .tooltip { visibility: visible; opacity: 1; }
        .marks-container { background: #ffffff; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); width: 90%; max-width: 1000px; margin-top: 40px; transition: all 0.3s ease; position: relative; }
        .marks-container:hover { box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); }
        .selection-container { margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; }
        select, input { padding: 12px; font-size: 14px; border: 1px solid #dcdcdc; border-radius: 6px; background: #f9f9f9; transition: all 0.3s ease; }
        select:focus, input:focus { border-color: #3498db; background: #fff; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); outline: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #2ecc71; color: #fff; font-weight: 600; }
        tr:hover { background: #f5f5f5; }
        input[type="number"] { width: 80px; }
        .submit-btn { padding: 12px 28px; background: #2ecc71; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background 0.3s ease; margin-top: 20px; display: block; margin-left: auto; margin-right: auto; }
        .submit-btn:hover { background: #27ae60; }
        .submit-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        .error { color: #e74c3c; font-size: 14px; margin-top: 10px; text-align: center; }
        .notification-card { background: #ffffff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); font-size: 14px; color: #2c3e50; text-align: center; opacity: 0; transition: opacity 0.5s ease; margin-top: 10px; max-width: 80%; margin-left: auto; margin-right: auto; }
        .notification-card.active { opacity: 1; }
        @media (max-width: 768px) {
            .header { padding: 15px 20px; flex-direction: row; justify-content: space-between; }
            .header-greeting { font-size: 22px; }
            .hamburger { display: block; }
            .menu { display: none; position: absolute; top: 60px; right: 20px; background: #fff; border-radius: 6px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); padding: 10px; flex-direction: column; gap: 8px; }
            .menu.active { display: flex; }
            .back-btn { font-size: 14px; padding: 10px 15px; }
            .menu-btn { font-size: 14px; padding: 10px 15px; width: 100%; }
            .marks-container { padding: 20px; }
            .selection-container { flex-direction: column; }
            select, input { width: 100%; font-size: 13px; padding: 10px; }
            th, td { font-size: 12px; padding: 8px; }
            input[type="number"] { width: 60px; }
            .submit-btn { font-size: 14px; padding: 10px 22px; }
            .notification-card { font-size: 12px; padding: 8px 16px; max-width: 90%; }
        }
    </style>
</head>
<body onload="initializeMarksEntry()">
    <div class="header">
        <button class="back-btn" onclick="goBack()" aria-label="Back to Dashboard">
            Back
            <span class="tooltip">Return to Dashboard</span>
        </button>
        <span class="header-greeting" id="headerGreeting">Marks Entry</span>
        <div class="menu-container">
            <button class="hamburger" onclick="toggleMenu()" aria-label="Toggle menu">â˜°</button>
            <div class="menu" id="headerMenu">
                <button class="menu-btn" onclick="logout()" aria-label="Logout">
                    Logout
                    <span class="tooltip">End your session</span>
                </button>
            </div>
        </div>
    </div>
    <div class="marks-container" id="marksContainer">
        <div class="selection-container">
            <select id="deptSelect" onchange="updateSections()" aria-label="Select Department">
                <option value="">Select Department</option>
            </select>
            <select id="sectionSelect" onchange="loadStudents()" aria-label="Select Section">
                <option value="">Select Section</option>
            </select>
        </div>
        <table id="marksTable">
            <thead>
                <tr>
                    <th>Roll Number</th>
                    <th>Mid-term (15)</th>
                    <th>Assignment (5)</th>
                    <th>Quiz (10)</th>
                </tr>
            </thead>
            <tbody id="marksBody"></tbody>
        </table>
        <button class="submit-btn" id="submitBtn" onclick="submitMarks()" aria-label="Submit Marks" disabled>Submit Marks</button>
        <div id="notificationCard" class="notification-card"></div>
        <div class="error" id="errorMessage"></div>
    </div>

    <script>
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            window.location.href = 'login.html';
        }

        const userEmail = loggedInUser.email;
        const urlParams = new URLSearchParams(window.location.search);
        let currentDepartment = decodeURIComponent(urlParams.get('dept') || '');
        let currentSection = decodeURIComponent(urlParams.get('section') || '');
        const deptKey = `departments-${userEmail}`;
        const attendanceKey = `attendance-${userEmail}`;
        const marksKey = `marks-${userEmail}`;
        let departmentsDB = JSON.parse(localStorage.getItem(deptKey)) || [];
        let attendanceDB = JSON.parse(localStorage.getItem(attendanceKey)) || {};
        let marksDB = JSON.parse(localStorage.getItem(marksKey)) || {};

        function initializeMarksEntry() {
            document.getElementById('headerGreeting').textContent = `Marks Entry${currentDepartment && currentSection ? ` - ${currentDepartment.toUpperCase()}-${currentSection.toUpperCase()}` : ''}`;
            
            const deptSelect = document.getElementById('deptSelect');
            departmentsDB.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                deptSelect.appendChild(option);
            });

            if (currentDepartment && currentSection) {
                deptSelect.value = currentDepartment;
                updateSections();
                document.getElementById('sectionSelect').value = currentSection;
                loadStudents();
            }
        }

        function updateSections() {
            const deptSelect = document.getElementById('deptSelect');
            const sectionSelect = document.getElementById('sectionSelect');
            currentDepartment = deptSelect.value;
            sectionSelect.innerHTML = '<option value="">Select Section</option>';

            if (currentDepartment) {
                const dept = departmentsDB.find(d => d.name === currentDepartment);
                if (dept) {
                    dept.sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        sectionSelect.appendChild(option);
                    });
                } else {
                    showNotification('No sections found for this department.');
                }
                document.getElementById('headerGreeting').textContent = `Marks Entry${currentSection ? ` - ${currentDepartment.toUpperCase()}-${currentSection.toUpperCase()}` : ''}`;
            }
            loadStudents();
        }

        function loadStudents() {
            const sectionSelect = document.getElementById('sectionSelect');
            currentSection = sectionSelect.value;
            const marksBody = document.getElementById('marksBody');
            marksBody.innerHTML = '';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('errorMessage').textContent = '';

            if (!currentDepartment || !currentSection) {
                marksBody.innerHTML = '<tr><td colspan="4">Please select a department and section.</td></tr>';
                return;
            }

            document.getElementById('headerGreeting').textContent = `Marks Entry - ${currentDepartment.toUpperCase()}-${currentSection.toUpperCase()}`;

            const sectionAttendance = attendanceDB[`${currentDepartment}-${currentSection}`] || { students: [] };
            if (sectionAttendance.students.length === 0) {
                marksBody.innerHTML = '<tr><td colspan="4">No students found. Please add students in Attendance first.</td></tr>';
                return;
            }

            const sectionMarks = marksDB[`${currentDepartment}-${currentSection}`] || {};
            sectionAttendance.students.forEach(student => {
                const marks = sectionMarks[student.label] || { midterm: '', assignment: '', quiz: '' };
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.label}</td>
                    <td><input type="number" min="0" max="15" value="${marks.midterm}" data-roll="${student.label}" data-type="midterm" oninput="validateMarks(this)"></td>
                    <td><input type="number" min="0" max="5" value="${marks.assignment}" data-roll="${student.label}" data-type="assignment" oninput="validateMarks(this)"></td>
                    <td><input type="number" min="0" max="10" value="${marks.quiz}" data-roll="${student.label}" data-type="quiz" oninput="validateMarks(this)"></td>
                `;
                marksBody.appendChild(row);
            });
            document.getElementById('submitBtn').disabled = false;
        }

        function validateMarks(input) {
            const value = parseFloat(input.value);
            const max = parseFloat(input.max);
            const roll = input.dataset.roll;
            const type = input.dataset.type;

            if (isNaN(value) || value < 0 || value > max) {
                input.value = '';
                document.getElementById('errorMessage').textContent = `Invalid ${type} marks for ${roll}. Must be between 0 and ${max}.`;
            } else {
                document.getElementById('errorMessage').textContent = '';
            }
        }

        function submitMarks() {
            const marksBody = document.getElementById('marksBody');
            const inputs = marksBody.querySelectorAll('input');
            const sectionMarks = {};

            inputs.forEach(input => {
                const roll = input.dataset.roll;
                const type = input.dataset.type;
                const value = input.value.trim();

                if (!sectionMarks[roll]) sectionMarks[roll] = { midterm: '', assignment: '', quiz: '' };
                sectionMarks[roll][type] = value === '' ? '' : parseFloat(value).toString();
            });

            marksDB[`${currentDepartment}-${currentSection}`] = sectionMarks;
            localStorage.setItem(marksKey, JSON.stringify(marksDB));
            
            // Show notification below submit button
            showNotification('Submit Successfully');
            
            // Refresh the page after 2 seconds (after notification fades)
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        function goBack() {
            try {
                document.body.style.opacity = '0.7';
                document.body.style.cursor = 'wait';
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 300);
            } catch (error) {
                console.error('Navigation error:', error);
                showNotification('Navigation failed. Please try again.');
                document.body.style.opacity = '1';
                document.body.style.cursor = 'default';
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.body.style.opacity = '0.7';
                document.body.style.cursor = 'wait';
                localStorage.setItem('lastLogin', Date.now());
                localStorage.removeItem('loggedInUser');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 300);
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('headerMenu');
            menu.classList.toggle('active');
            document.addEventListener('click', closeMenuOutside, { once: true });
        }

        function closeMenuOutside(e) {
            const menu = document.getElementById('headerMenu');
            const hamburger = document.querySelector('.hamburger');
            if (!menu.contains(e.target) && !hamburger.contains(e.target)) {
                menu.classList.remove('active');
            }
        }

        function showNotification(message) {
            const notificationCard = document.getElementById('notificationCard');
            if (notificationCard) {
                notificationCard.textContent = message;
                notificationCard.classList.add('active');
                setTimeout(() => {
                    notificationCard.classList.remove('active');
                }, 2000);
            }
        }
    </script>
</body>
</html>