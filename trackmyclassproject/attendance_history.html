<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Data - Smart Register</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    min-height: 100vh;
    background: linear-gradient(135deg, #2ecc71, #3498db);
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: opacity 0.3s ease;
    overflow-x: hidden; /* Prevent horizontal scroll */
}

.header {
    width: 100%;
    padding: 20px 40px;
    background: #ffffff;
    border-radius: 0 0 15px 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: all 0.3s ease;
}

.header:hover {
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
}

.header-greeting {
    font-size: 26px;
    font-weight: 600;
    color: #2c3e50;
    text-align: center;
    flex-grow: 1;
}

.hamburger {
    display: none;
    font-size: 24px;
    background: none;
    border: none;
    color: #2c3e50;
    cursor: pointer;
    padding: 5px;
}

.menu-container {
    position: relative;
}

.menu {
    display: flex;
    gap: 10px;
}

.back-btn {
    padding: 12px 20px;
    background: #3498db;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background 0.3s ease, transform 0.2s ease;
    position: relative;
    overflow: hidden;
}

.back-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.menu-btn {
    padding: 12px 20px;
    background: #e74c3c;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background 0.3s ease, transform 0.2s ease;
}

.menu-btn:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

.tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #34495e;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.2s ease;
    margin-bottom: 5px;
}

.back-btn:hover .tooltip,
.menu-btn:hover .tooltip {
    visibility: visible;
    opacity: 1;
}

.search-container {
    width: 90%;
    max-width: 1200px;
    display: flex;
    gap: 10px;
    margin-top: 40px;
    margin-bottom: 15px;
    justify-content: center;
}

.search-container input {
    padding: 12px;
    font-size: 14px;
    border: 1px solid #dcdcdc;
    border-radius: 6px;
    background: #f9f9f9;
    width: 40%;
    max-width: 300px;
    transition: all 0.3s ease;
}

.search-container input:focus {
    border-color: #3498db;
    background: #fff;
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
    outline: none;
}

.search-container input::placeholder {
    color: #7f8c8d;
}

.history-container {
    width: 90%;
    max-width: 1200px;
    background: #ffffff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    height: calc(100vh - 200px); /* Dynamic height for most of the screen */
    min-height: 300px; /* Minimum height for usability */
    position: relative;
}

.history-container:hover {
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
}

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* Changed to auto for better content fitting */
}

th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #dcdcdc;
    color: #34495e;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal; /* Allow text wrapping */
}

th {
    background: #2ecc71;
    color: #fff;
    font-weight: 500;
}

td:nth-child(1) { width: 30%; } /* Date-Time */
td:nth-child(2) { width: 30%; } /* Department-Section */
td:nth-child(3) { width: 40%; } /* Absent */

tr:hover {
    background: #f9f9f9;
}

.context-menu {
    position: absolute;
    background: #ffffff;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    z-index: 2000;
    display: none;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.context-menu.active {
    display: flex;
    opacity: 1;
}

.context-menu button {
    padding: 12px 16px;
    background: #3498db;
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.3s ease;
}

.context-menu button:hover {
    background: #2980b9;
}

.context-menu .delete-btn {
    background: #e74c3c;
}

.context-menu .delete-btn:hover {
    background: #c0392b;
}

.back-button {
    margin-top: 20px;
    padding: 12px 28px;
    background: #2ecc71;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background 0.3s ease;
}

.back-button:hover {
    background: #27ae60;
}

.notification-card {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffffff;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    color: #2c3e50;
    text-align: center;
    opacity: 0;
    transition: opacity 0.5s ease;
    z-index: 1500;
    max-width: 80%;
}

.notification-card.active {
    opacity: 1;
}

@media (max-width: 768px) {
    .header {
        padding: 15px 20px;
        flex-direction: row;
        justify-content: space-between;
    }
    .header-greeting {
        font-size: 22px;
    }
    .hamburger {
        display: block;
    }
    .menu {
        display: none;
        position: absolute;
        top: 60px;
        right: 20px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: 10px;
        flex-direction: column;
        gap: 8px;
    }
    .menu.active {
        display: flex;
    }
    .back-btn {
        font-size: 14px;
        padding: 10px 15px;
    }
    .menu-btn {
        font-size: 14px;
        padding: 10px 15px;
        width: 100%;
    }
    .search-container {
        flex-direction: column;
        gap: 8px;
        margin-top: 50px; /* Adjusted for smaller header */
    }
    .search-container input {
        width: 100%;
        max-width: none;
        font-size: 13px;
        padding: 10px;
    }
    .history-container {
        padding: 15px;
        height: calc(100vh - 180px); /* Adjusted height */
        max-width: 95%; /* Slightly wider */
    }
    th, td {
        font-size: 12px;
        padding: 10px;
    }
    td:nth-child(1), td:nth-child(2), td:nth-child(3) {
        width: auto; /* Remove fixed widths on mobile */
    }
    .back-button {
        font-size: 14px;
        padding: 10px 22px;
    }
    .notification-card {
        font-size: 12px;
        padding: 8px 16px;
        max-width: 90%;
    }
}

@media (max-width: 480px) {
    .header-greeting {
        font-size: 18px;
    }
    .back-btn {
        font-size: 12px;
        padding: 8px 12px;
    }
    .menu-btn {
        font-size: 12px;
        padding: 8px 12px;
    }
    .search-container input {
        font-size: 11px;
    }
    .history-container {
        padding: 10px;
        height: calc(100vh - 160px); /* Further adjusted height */
    }
    th, td {
        font-size: 10px;
        padding: 6px;
    }
    .back-button {
        font-size: 13px;
        padding: 8px 20px;
    }
}
    </style>
</head>
<body onload="loadHistory()">
    <div class="header">
        <button class="back-btn" onclick="goBack()" aria-label="Back to Dashboard">
            Back
            <span class="tooltip">Return to Dashboard</span>
        </button>
        <span class="header-greeting" id="headerGreeting">Welcome, User!</span>
        <div class="menu-container">
            <button class="hamburger" onclick="toggleMenu()" aria-label="Toggle menu">â˜°</button>
            <div class="menu" id="headerMenu">
                <button class="menu-btn" onclick="logout()" aria-label="Logout">
                    Logout
                    <span class="tooltip">End your session</span>
                </button>
            </div>
        </div>
    </div>
    <div class="search-container">
        <input type="text" id="deptSearch" placeholder="Search Department (e.g., CSE)" oninput="filterHistory()" aria-label="Search by department">
        <input type="text" id="sectionSearch" placeholder="Search Section (e.g., Sec A)" oninput="filterHistory()" aria-label="Search by section">
    </div>
    <div class="history-container" id="historyContainer">
        <div id="notificationCard" class="notification-card"></div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Date-Time</th>
                    <th>Department-Section</th>
                    <th>Absent</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
    <button class="back-button" onclick="navigateTo('index.html')" aria-label="Back to Home">Back to Home</button>
    <div id="contextMenu" class="context-menu"></div>

    <script>
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            window.location.href = 'login.html';
        }

        const userEmail = loggedInUser.email;
        const historyKey = `history-${userEmail}`;
        let historyDB = JSON.parse(localStorage.getItem(historyKey)) || [];
        let currentRecordIndex = null;

        document.getElementById('headerGreeting').textContent = `Welcome, ${loggedInUser.username}!`;

        function loadHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            if (historyDB.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">No attendance records found.</td></tr>';
                return;
            }
            historyDB.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleString()}</td>
                    <td>${record.department}-${record.section}</td>
                    <td>${record.absent.join(', ') || 'None'}</td>
                `;
                row.dataset.dept = record.department.toLowerCase();
                row.dataset.section = record.section.toLowerCase();
                row.dataset.index = index;
                row.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, index);
                });
                tbody.appendChild(row);
            });
        }

        function filterHistory() {
            const deptInput = document.getElementById('deptSearch').value.toLowerCase().trim();
            const sectionInput = document.getElementById('sectionSearch').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#historyBody tr');

            rows.forEach(row => {
                const dept = row.dataset.dept || '';
                const section = row.dataset.section || '';
                const deptMatch = dept.includes(deptInput);
                const sectionMatch = section.includes(sectionInput);
                row.style.display = (deptInput === '' || deptMatch) && (sectionInput === '' || sectionMatch) ? '' : 'none';
            });
        }

        function showContextMenu(e, index) {
            currentRecordIndex = index;
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.innerHTML = `
                <button class="edit-btn" onclick="editRecord()" aria-label="Edit record">Edit</button>
                <button class="delete-btn" onclick="deleteRecord()" aria-label="Delete record">Delete</button>
            `;
            contextMenu.classList.add('active');
            const { pageX: x, pageY: y } = e;
            const { offsetWidth: menuWidth, offsetHeight: menuHeight } = contextMenu;
            contextMenu.style.left = `${Math.min(x, window.innerWidth - menuWidth)}px`;
            contextMenu.style.top = `${Math.min(y, window.innerHeight - menuHeight)}px`;
            document.addEventListener('click', hideContextMenu, { once: true });
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
            currentRecordIndex = null;
        }

        function editRecord() {
            if (currentRecordIndex === null) return;
            const record = historyDB[currentRecordIndex];
            const newDatetime = prompt('Edit Date-Time (YYYY-MM-DD HH:MM):', new Date(record.date).toLocaleString());
            const newDeptSection = prompt('Edit Department-Section (e.g., IT-SEC A):', `${record.department}-${record.section}`);
            const newAbsent = prompt('Edit Absent Students (comma-separated):', record.absent.join(', '));

            if (newDatetime && newDeptSection) {
                const [newDept, newSection] = newDeptSection.split('-').map(part => part.trim());
                if (!newDept || !newSection) {
                    showNotification('Please provide both department and section (e.g., IT-SEC A).');
                    return;
                }
                historyDB[currentRecordIndex] = {
                    date: new Date(newDatetime).toISOString(),
                    department: newDept,
                    section: newSection,
                    absent: newAbsent ? newAbsent.split(',').map(s => s.trim()) : record.absent
                };
                localStorage.setItem(historyKey, JSON.stringify(historyDB));
                loadHistory();
                filterHistory();
            }
            hideContextMenu();
        }

        function deleteRecord() {
            if (currentRecordIndex === null || !confirm(`Delete record from ${new Date(historyDB[currentRecordIndex].date).toLocaleString()}?`)) return;
            historyDB.splice(currentRecordIndex, 1);
            localStorage.setItem(historyKey, JSON.stringify(historyDB));
            loadHistory();
            filterHistory();
            hideContextMenu();
        }

        function navigateTo(page) {
            try {
                document.body.style.opacity = '0.7';
                document.body.style.cursor = 'wait';
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
                setTimeout(() => {
                    window.location.href = page;
                }, 300);
            } catch (error) {
                console.error('Navigation error:', error);
                showNotification('Navigation failed. Please try again.');
                document.body.style.opacity = '1';
                document.body.style.cursor = 'default';
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function goBack() {
            document.body.style.opacity = '0.7';
            document.body.style.cursor = 'wait';
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 300);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.body.style.opacity = '0.7';
                document.body.style.cursor = 'wait';
                localStorage.setItem('lastLogin', Date.now());
                localStorage.removeItem('loggedInUser');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 300);
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('headerMenu');
            menu.classList.toggle('active');
            document.addEventListener('click', closeMenuOutside, { once: true });
        }

        function closeMenuOutside(e) {
            const menu = document.getElementById('headerMenu');
            const hamburger = document.querySelector('.hamburger');
            if (!menu.contains(e.target) && !hamburger.contains(e.target)) {
                menu.classList.remove('active');
            }
        }

        function showNotification(message) {
            const notificationCard = document.getElementById('notificationCard');
            notificationCard.textContent = message;
            notificationCard.classList.add('active');
            setTimeout(() => {
                notificationCard.classList.remove('active');
            }, 2000);
        }
    </script>
</body>
</html>